<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>라면 조리 도우미</title>
  <style>
    :root {
      --bg:#0b0c10; --card:#111318; --muted:#868e96; --fg:#e9ecef; --accent:#7cfc00;
      --border:#262a33; --chip:#1b1e26;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; background:linear-gradient(180deg,#0b0c10 0%, #0d1117 100%); color:var(--fg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      line-height:1.55;
    }
    header {
      position: sticky; top:0; backdrop-filter: blur(8px);
      background: rgba(13,17,23,0.6); border-bottom:1px solid var(--border);
      padding:12px 16px; z-index:10;
      display:flex; align-items:center; gap:12px;
    }
    header h1 { font-size:16px; margin:0; font-weight:700; letter-spacing: .3px; }
    header .hint { color:var(--muted); font-size:12px; }
    main { max-width:980px; margin: 20px auto; padding: 0 16px 80px; }
    .row { display:flex; gap:16px; align-items:stretch; }
    .col { flex:1; }
    .card {
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px;
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
    }
    .card h2 { margin:0 0 8px; font-size:14px; letter-spacing:.3px; color:#cbd3da }
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip {
      background:var(--chip); border:1px solid var(--border); padding:6px 10px; border-radius:999px;
      font-size:12px; color:#cbd3da; cursor:pointer;
    }
    .chip:hover { border-color:#2f3540 }
    .profiles-list { display:flex; gap:8px; flex-wrap:wrap; }
    .profile-item {
      background:var(--chip); border:1px solid var(--border); padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    .profile-item.active { outline:2px solid var(--accent); }
    .facts { display:grid; grid-template-columns: 1fr 1fr; gap:8px 12px; margin-top:8px; }
    .facts .k { color:#9aa4ae; font-size:12px }
    .facts .v { font-weight:600; }
    .bubbles { display:flex; flex-direction:column; gap:8px; }
    .bubble {
      max-width:80%; padding:10px 12px; border-radius:14px; border:1px solid var(--border);
      background:#0f1420; animation: slide .15s ease-out;
      white-space: pre-wrap;
    }
    .bubble.me { margin-left:auto; background:#152035; }
    .bubble.ai { margin-right:auto; }
    @keyframes slide { from { transform: translateY(6px); opacity:.0 } to { transform: none; opacity:1 } }
    .composer { position:fixed; left:0; right:0; bottom:0; padding:12px 16px; background:rgba(13,17,23,.75); border-top:1px solid var(--border); backdrop-filter: blur(10px); }
    .composer form { max-width:980px; margin:0 auto; display:flex; gap:8px; }
    input[type="text"] {
      flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0f1420; color:var(--fg);
    }
    button {
      padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#172034; color:var(--fg); cursor:pointer;
    }
    button.primary { background:#1b2a4b; border-color:#28406f; }
    .muted { color:var(--muted); font-size:12px; }
    .mt8 { margin-top:8px } .mt12{ margin-top:12px } .mt16{ margin-top:16px }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <header>
    <h1>라면 조리 도우미</h1>
    <div class="hint">키워드: "프로필 목록", "요약", "남은 질문", "○○로 전환", "국물 성향"</div>
    <div style="margin-left:auto; display:flex; gap:8px;">
      <button id="btnLoad">세션 불러오기</button>
      <button id="btnSave">세션 저장</button>
    </div>
  </header>

  <main>
    <div class="row">
      <div class="col card">
        <h2>대화</h2>
        <div id="bubbles" class="bubbles"></div>
      </div>
      <div class="col card">
        <h2>프로필</h2>
        <div id="profiles" class="profiles-list"></div>
        <div id="facts" class="facts mt12"></div>
        <div class="mt12 muted">필드: 물량(ml), 삶는 시간, 국물 성향, 계란 스타일</div>
        <div class="mt16">
          <div class="chips">
            <div class="chip" data-q="프로필 목록">프로필 목록</div>
            <div class="chip" data-q="요약">요약</div>
            <div class="chip" data-q="남은 질문">남은 질문</div>
            <div class="chip" data-q="신라면으로 전환">신라면 전환</div>
            <div class="chip" data-q="국물 성향은 얼큰하게">국물 성향</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="composer">
    <form id="form">
      <input id="input" type="text" placeholder="메시지를 입력하세요. 예: 남은 질문 / 진라면으로 전환 / 물 550ml" />
      <button class="primary" type="submit">보내기</button>
    </form>
  </div>

<script>
//0) 유틸
const normalize = s => s.normalize('NFC').toLowerCase().replace(/\s+/g, ' ').trim();  //입력 정규화
const squish    = s => s.replace(/\s/g, ''); //공백제거
const say = (text, who='ai') => {   //대화 시각화
  const wrap = document.createElement('div');
  wrap.className = 'bubble ' + (who === 'me' ? 'me' : 'ai');
  wrap.textContent = text;
  document.querySelector('#bubbles').appendChild(wrap);
  wrap.scrollIntoView({behavior:'smooth', block:'end'});
};
const byId = id => document.getElementById(id); 

//1) State & Persistence

//전체 상태
const STATE = {
  version: 1,                         //데이터 구조 버전    
  active: null,                       //활성 프로필
  profiles: {},                       //라면 객체 저장소
  doneNotified: false,                //완료 멘트 중복 방지
  schema: { customQuestions: [] },    //사용자 정의 질문 저장소(미구현)
  synonyms: {},                       //동의어 저장소(미구현)
  stats: {}                           //통계 저장소 (미구현)
};

function ensureProfile(name) {     
  if (!STATE.profiles[name]) {    //이름에 해당하는 프로필 없을 때 생성
    STATE.profiles[name] = {
      facts: {},                  //라면 속성 값 
      history: [],                //대화 내용 
      createdAt: Date.now(),      //생성 시간
      updatedAt: Date.now()       //최종 수정 시간
    };
  }

  if (!STATE.active) STATE.active = name; //이름에 해당하는 프로필 존재시 활성프로필에 등록
}

function getActiveProfile() {         //활성화된 라면의 정보 반환
  if (!STATE.active) return null;
  return STATE.profiles[STATE.active];
}

function getRemainingFields(p = getActiveProfile()) {
  if (!p) return [];                                                //활성 프로필 없을 때 빈 배열 반환
  const NEED = ['water_ml','boil_time','soup_profile','egg_style']; //필수 속성
  return NEED.filter(k => !p.facts[k]);                           //값이 비어있는 속성 반환
}

async function loadFromFileHandle(handle) { //저장된 세션 불러오기 
  const file = await handle.getFile();      //파일 내용을 가져옴
  const text = await file.text();           //파일 내부의 텍스트를 읽음
  const data = JSON.parse(text);            //JSON 문자열을 JAVAscript 객체로 변환
  
  ['version','profiles','active','schema','synonyms','stats'].forEach(k => {
    if (data[k] !== undefined) STATE[k] = data[k];
  });                                       //해당 내용을 STATE에 덮어씌움
  renderProfiles();
  renderFacts();
  say('세션을 불러왔습니다.');               //말풍선 출력
}

async function saveToFileHandle(handle) {                 //세션 저장
  const writable = await handle.createWritable();         //파일을 쓰기 모드로 준비
  await writable.write(JSON.stringify(STATE, null, 2));   //STATE 내용을 JSON 문자열로 변환하여 파일에 기록
  await writable.close();   
  say('세션을 저장했습니다.');
}

let fileHandle = null;  

//2) Intent Module
const INTENTS = [
  {
    name: 'LIST_PROFILES',
    anyOf: ['프로필 목록','프로필 보여줘','프로필 알려줘','목록','리스트'],
    regex: [/(프로필|라면).*(목록|리스트|보여줘|알려줘)/]
  },
  {
    name: 'SUMMARY',
    anyOf: ['요약','정리','요약해줘','정리해줘'],
    regex: [/(요약|정리)(해줘|해봐|해줄래)?$/]
  },
  {
    name: 'REMAINING',
    anyOf: ['남은질문','남은 질문','미답변','충족도','완료율']
  },
  {
    name: 'SWITCH_PROFILE',
    regex: [/(.+?)(?:으)?로\s*(전환|바꿔줘|바꿔)$/],
    extract: (m) => ({ target: m[1].trim() })
  },
  {
    name: 'ASK_SOUP_PROFILE',
    regex: [/((국물|스프).*(성향|맛)|맛\s*성향)/]
  },
];

function guessField(t) {
  if (/물|ml|cc/.test(t)) return 'water_ml';
  if (/(삶|끓|타이머|분|초)/.test(t)) return 'boil_time';
  if (/계란|달걀|수란|반숙|완숙|스크램블/.test(t)) return 'egg_style';
  if (/((국물|스프).*(성향|맛)|맛\s*성향)/.test(t)) return 'soup_profile';
  return null;
}

function detectIntent(raw) {
  const t = normalize(raw);
  const tNS = squish(t);
  for (const it of INTENTS) {
    if (it.anyOf && it.anyOf.some(k => {
      const nk = normalize(k);
      return t.includes(nk) || tNS.includes(squish(nk));
    })) return { type: it.name };
    if (it.regex) for (const r of it.regex) {
      const m = t.match(r);
      if (m) return { type: it.name, ...(it.extract ? it.extract(m) : {}) };
    }
  }
  const field = guessField(t);
  return field ? { type: 'ASK_FIELD', field } : { type: 'UNKNOWN' };
}

//3) Domain Handlers
function showProfiles() {
  const names = Object.keys(STATE.profiles);
  if (names.length === 0) return say('저장된 프로필이 없습니다. 예: "신라면으로 전환"을 입력해 새 프로필을 만드세요.');
  say('프로필 목록: ' + names.map(n => STATE.active === n ? `${n}★` : n).join(', '));
}

function showSummary() {
  const p = getActiveProfile();
  if (!p) return say('활성 프로필이 없습니다. 먼저 "○○로 전환"으로 프로필을 선택하세요.');
  const w  = p.facts.water_ml   || '물량 미정';
  const bt = p.facts.boil_time  || '시간 미정';
  const sp = p.facts.soup_profile || '국물 성향 미정';
  const egg= p.facts.egg_style  || '계란 미정';
  say(`현재 설정: 물 ${w}, 삶기 ${bt}, 국물 ${sp}, 계란 ${egg}.` + 
      (getRemainingFields(p).length ? ' 핵심 세팅이 거의 채워졌어요!' : ' 핵심 세팅 완료!'));
}

function showRemaining() {
  const p = getActiveProfile();
  if (!p) return say('활성 프로필이 없습니다.');
  const rem = getRemainingFields(p);
  if (rem.length === 0) {
    if (!STATE.doneNotified) {
      STATE.doneNotified = true;
      say('모든 핵심 세팅이 완료되었습니다! 🎉 "요약"을 확인해 보세요.');
    } else {
      say('이미 모든 항목이 채워졌습니다. "요약"을 입력해 보세요!');
    }
  } else {
    STATE.doneNotified = false;
    say(`남은 질문: ${rem.join(', ')}`);
  }
}

function switchProfile(target) {
  if (!target) return say('전환할 프로필 이름이 필요해요.');
  ensureProfile(target);
  STATE.active = target;
  STATE.profiles[target].updatedAt = Date.now();
  renderProfiles();
  renderFacts();
  say(`프로필을 [${target}]으로 전환했어요.`);
}

function askField(field, input) {
  const p = getActiveProfile();
  if (!p) return say('먼저 프로필을 선택하세요. "신라면으로 전환" 등을 입력하면 됩니다.');
  // 간단 파서
  const t = normalize(input);
  if (field === 'water_ml') {
    const m = t.match(/(\d{2,4})\s*(ml|cc)?/);
    if (m) {
      p.facts.water_ml = `${m[1]}ml`;
      renderFacts(); say(`물량을 ${p.facts.water_ml}로 기록했어요.`); return;
    }
    return say('물 용량을 알려주세요. 예: 500ml');
  }
  if (field === 'boil_time') {
    const m = t.match(/(\d+)\s*분?\s*(\d+)?\s*초?/);
    if (m) {
      const mm = m[1], ss = m[2]||'0';
      p.facts.boil_time = `${mm}분 ${ss}초`;
      renderFacts(); say(`삶는 시간을 ${p.facts.boil_time}로 기록했어요.`); return;
    }
    return say('삶는 시간을 알려주세요. 예: 4분 30초');
  }
  if (field === 'soup_profile') {
    const m = t.match(/(순한맛|담백|적당히 매운맛|얼큰|매운|진한|가벼운)/);
    p.facts.soup_profile = m ? m[1].replace('얼큰','얼큰한') : '기본';
    renderFacts(); return say(`국물 성향을 ${p.facts.soup_profile}으로 기록했어요.`);
  }
  if (field === 'egg_style') {
    const m = t.match(/(수란|반숙|완숙|스크램블|계란 없음)/);
    p.facts.egg_style = m ? m[1] : '계란 없음';
    renderFacts(); return say(`계란 스타일을 ${p.facts.egg_style}로 기록했어요.`);
  }
  return say('해당 필드를 이해하지 못했어요.');
}

function handleField(field, input) {
  if (!field) return say('무슨 뜻인지 잘 못 알아들었어요. "남은 질문"이나 "요약"을 시도해 보세요.');
  return askField(field, input);
}

/* ========================
   4) UI Render
======================== */
function renderProfiles() {
  const root = byId('profiles'); root.innerHTML='';
  const names = Object.keys(STATE.profiles);
  if (names.length === 0) { root.textContent = '프로필이 없습니다.'; return; }
  names.forEach(n => {
    const el = document.createElement('div');
    el.className = 'profile-item' + (STATE.active === n ? ' active' : '');
    el.textContent = n;
    el.onclick = () => switchProfile(n);
    root.appendChild(el);
  });
}

function renderFacts() {
  const root = byId('facts'); root.innerHTML='';
  const p = getActiveProfile();
  if (!p) { root.textContent = '활성 프로필 없음'; return; }
  const pairs = [
    ['물량(ml)','water_ml'], ['삶는 시간','boil_time'],
    ['국물 성향','soup_profile'], ['계란 스타일','egg_style']
  ];
  for (const [k, key] of pairs) {
    const rowK = document.createElement('div'); rowK.className='k'; rowK.textContent=k;
    const rowV = document.createElement('div'); rowV.className='v'; rowV.textContent=p.facts[key]||'-';
    root.appendChild(rowK); root.appendChild(rowV);
  }
}

/* ========================
   5) Orchestrator
======================== */
function answerQuestion(input) {
  const intent = detectIntent(input);
  switch (intent.type) {
    case 'LIST_PROFILES': return showProfiles();
    case 'SUMMARY': return showSummary();
    case 'REMAINING': return showRemaining();
    case 'SWITCH_PROFILE': return switchProfile(intent.target);
    case 'ASK_SOUP_PROFILE': return askField('soup_profile', input);
    case 'ASK_FIELD': return handleField(intent.field, input);
    case 'UNKNOWN':
    default: return say('잘 이해하지 못했어요. "남은 질문", "요약", "○○로 전환" 등을 시도해 보세요.');
  }
}

/* ========================
   6) Events
======================== */
byId('form').addEventListener('submit', (e) => {
  e.preventDefault();
  const inp = byId('input');
  const text = inp.value.trim();
  if (!text) return;
  say(text, 'me');
  answerQuestion(text);
  // 기록
  const p = getActiveProfile();
  if (p) {
    p.history.push({role:'me', text});
    if (p.history.length > 200) p.history.shift();
    p.updatedAt = Date.now();
  }
  inp.value='';
});

document.addEventListener('click', (e) => {
  const chip = e.target.closest('.chip');
  if (chip?.dataset.q) {
    const q = chip.dataset.q;
    say(q, 'me');
    answerQuestion(q);
  }
});

byId('btnLoad').addEventListener('click', async () => {
  if (!window.showOpenFilePicker) { say('이 브라우저는 파일 선택 API를 지원하지 않습니다.'); return; }
  try {
    const [h] = await showOpenFilePicker({types:[{description:'JSON', accept:{'application/json':['.json']}}]});
    fileHandle = h;
    await loadFromFileHandle(h);
  } catch (e) {
    // 취소 등
  }
});

byId('btnSave').addEventListener('click', async () => {
  if (!window.showSaveFilePicker) { say('이 브라우저는 파일 저장 API를 지원하지 않습니다.'); return; }
  try {
    if (!fileHandle) {
      fileHandle = await showSaveFilePicker({suggestedName:'ramen_session.json', types:[{description:'JSON', accept:{'application/json':['.json']}}]});
    }
    await saveToFileHandle(fileHandle);
  } catch (e) {
    // 취소 등
  }
});
</script>
</body>
</html>
