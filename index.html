<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¼ë©´ ì†Œìƒì Â· ì§ˆë¬¸í•˜ëŠ” AI (MVP)</title>
    <style>
        :root{
            --bg: #0b0d12; 
            --panel: #121621; 
            --panel-2: #1a2030; 
            --text: #e9edf5; 
            --muted: #a9b4c7;
            --acc: #7cc7ff; 
            --acc-2: #ffd37c; 
            --danger: #ff8a7c; 
            --ok: #8dff7c;
            --radius: 18px; 
            --shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        *{
            box-sizing: border-box
        }
        
        html,body{
            height: 100%
        }

        body{
            margin: 0;
            background: radial-gradient(1200px 800px at 80% -10%,#17203a33,transparent),var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,sans-serif;
            color: var(--text);
        }

        .wrap{
            max-width: 980px;
            margin: 40px auto;
            padding: 0 16px
        }

        header{
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px
        }

        header .logo{
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg,var(--acc),var(--acc-2));
            display: grid;
            place-items: center;
            color: #0b0d12;
            font-weight: 900;
            box-shadow: var(--shadow)
        }

        header h1{
            font-size: clamp(20px,3.8vw,32px);
            margin: 0
        }

        header p{
            margin: 0;
            color: var(--muted)
        }

        .panel{
            background: linear-gradient(180deg,var(--panel),var(--panel-2));
            border: 1px solid #222a3a;
            border-radius: var(--radius);
            box-shadow: var(--shadow)
        }

        .grid{
            display: grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 16px
        }

        @media (max-width: 860px){
            .grid{
                grid-template-columns: 1fr;
            }
        }

        .section{
            padding: 18px
        }

        .section h2{
            margin: 0 0 10px;
            font-size: 18px
        }

        .section p.note{
            margin: .4rem 0 1rem;
            color: var(--muted);
            font-size: 14px
        }

        .row{
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 8px 0
        }

        .row input, .row select{
            flex: 1;
            background: #0f1421;
            border: 1px solid #2a3347;
            color: var(--text);
            border-radius: 12px;
            padding: 10px 12px
        }

        .row button{
            background: #1e2a42;
            border: 1px solid #2d3a58;
            color: var(--text);
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer
        }

        .row button:hover{
            filter: brightness(1.1)
        }

        .chat{
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px;
            height: 460px;
            overflow: auto;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius)
        }

        .bubble{
            max-width: 82%;
            padding: 12px 14px;
            border-radius: 14px;
            line-height: 1.4
        }

        .ai{
            align-self: flex-start;
            background: #12213a;
            border: 1px solid #2b3c5a
        }

        .me{
            align-self: flex-end;
            background: #1d2a2f;
            border: 1px solid #2a3e3a
        }

        .inputbar{
            display: flex;
            gap: 10px;
            padding: 12px;
            border-top: 1px solid #26304a;
            background: #0e1422;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius)
        }

        .inputbar textarea{
            flex: 1;
            background: #0f1421;
            border: 1px solid #2a3347;
            color: var(--text);
            border-radius: 12px;
            padding: 12px;
            height: 56px;
            resize: none
        }

        .inputbar button{
            background: linear-gradient(135deg,var(--acc),#9fe6ff);
            color: #0b0d12;
            border: none;
            font-weight: 700;
            border-radius: 12px;
            padding: 0 18px;
            cursor: pointer
        }

        .state{
            padding: 12px;
            border-top: 1px dashed #2a3347;
            font-size: 14px;
            color: var(--muted)
        }

        .tags{
            display: flex; 
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px
        }

        .tag{
            font-size: 12px;
            padding: 6px 8px;
            border-radius: 999px;
            background: #111928;
            border: 1px solid #26304a;
            color: #c8d6f0
        }

        .statbar{
            height: 8px;
            background: #0e1422;
            border: 1px solid #2b3550;
            border-radius: 999px;
            overflow: hidden
        }
        
        .statbar > i{
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg,#4fd1ff,#b2f09b)
        }

        .pill{
            display:inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border: 1px solid #2c3750;
            border-radius: 12px;
            background: #0e1422
        }

        .pill input{
            width:140px
        }

        .ghost{
            opacity: .8
        }

        .muted{
            color: var(--muted)
        }

        .actions{
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }
    </style>
</head>
<body>
    <div class="wrap">
        <header>
        <div class="logo">ğŸœ</div>
        <div>
            <h1>ë¼ë©´ ì†Œìƒì Â· ì§ˆë¬¸í•˜ëŠ” AI</h1>
            <p>â€œAIê°€ ìŠ¤ìŠ¤ë¡œ ëª¨ë¥´ëŠ” ê²ƒì„ ë¬»ê³  ë°°ì›Œ ë¼ë©´ì„ ì¬íƒ„ìƒì‹œí‚¤ëŠ”â€ ì§ˆë¬¸ ì¤‘ì‹¬ MVP</p>
        </div>
        </header>

        <div class="grid">
        <!-- ì¢Œ: ì±„íŒ…/ì§ˆë¬¸ -->
        <section class="panel">
            <div class="section">
                <h2>ëŒ€í™”</h2>
                <p class="note">AIê°€ í˜„ì¬ ì§€ì‹ì˜ ë¹ˆì¹¸ì„ ë°œê²¬í•˜ë©´ ë¨¼ì € ì§ˆë¬¸í•©ë‹ˆë‹¤. ë‹µë³€ì€ ìì—°ì–´ë¡œ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.</p>
            </div>
            <div id="chat" class="chat"></div>
            <div class="inputbar">
                <textarea id="msg" placeholder="ë¼ë©´ì— ëŒ€í•´ ê¶ê¸ˆí•œê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”"></textarea>
                <button id="send">ë³´ë‚´ê¸°</button>
            </div>
            <div class="state">
                <div>ì§€ì‹ ì¶©ì¡±ë„</div>
                <div class="statbar" aria-label="coverage"><i id="coverage"></i></div>
                <div class="tags" id="needTags"></div>
            </div>
        </section>

        <!-- ìš°: ì„¸íŒ…/ì„¸ì…˜/ìš”ì•½ -->
        <section class="panel">
            <div class="section">
                <h2>ì„¸ì…˜</h2>
                <div class="row">
                    <span class="pill">ë¼ë©´ ì´ë¦„ <input id="ramenName"/></span>
                    <button id="start">ì„¸ì…˜ ì‹œì‘</button>
                    <button id="clear" class="ghost">ì´ˆê¸°í™”</button>
                </div>
                <p class="note">ì„¸ì…˜ì„ ì‹œì‘í•˜ë©´ AIê°€ ìš°ì„ ìˆœìœ„ ë†’ì€ ì§ˆë¬¸ë¶€í„° ìˆœì„œëŒ€ë¡œ ë˜ì§‘ë‹ˆë‹¤.</p>
                <div class="actions">
                    <button id="export">ë°ì´í„° ë‚´ë³´ë‚´ê¸°(JSON)</button>
                    <button id="import">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°(JSON)</button>
                    <input type="file" id="file" accept="application/json" hidden />
                    <button id="connectFile">ì„¸ì…˜ íŒŒì¼ ì—°ê²°</button>
                    <span class="note" style="font-size:12px">(Git ì €ì¥ì†Œ ì•ˆì˜ <code>ramen_session.json</code>ê³¼ ì—°ê²° ê¶Œì¥)</span>
                </div>
            </div>
            <div class="section">
                <div id="summary" class="muted">ì„¸ì…˜ì„ ì‹œì‘í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
                <div class="section">
                <div class="tags" id="policyTags"></div>
            </div>
        </section>
        </div>
    </div>

    <script>
        //ìƒíƒœ ì €ì¥ì†Œ
        const state = {
            ramenName: "",
            facts: {}, //ë¼ë©´ ì†ì„±
            history: [], //ëŒ€í™” ë‚´ì—­
            doneNotified: false, //ì™„ë£Œ ë©˜íŠ¸ ì¤‘ë³µ ë°©ì§€
        };

        // â–¼ ì—¬ëŸ¬ ë¼ë©´ì„ ë‹´ëŠ” v2 ì €ì¥ì†Œ
        const store = { 
            version: 2, profiles: {}, active: null 
        };

        store.schema = store.schema || { 
            customQuestions: [] 
        }; 

        store.synonyms = store.synonyms || {};

        let sessionHandle = null; // ì‚¬ìš©ì ì—°ê²° ì‹œ ì‹¤íŒŒì¼ë¡œ ìë™ ì €ì¥/ë¡œë“œ

        // ì§ˆë¬¸ ì„¤ê³„: key, text, hint, priority (0 í•„ìˆ˜, 1 ì¤‘ìš”, 2 ì„ íƒ), tags
        const QUESTION_BANK = [
            {key:"water_ml", text:"ë¬¼ì€ ëª‡ mLê°€ ê°€ì¥ ë§›ìˆë‚˜ìš”?", p:0, tags:["ë¬¼ëŸ‰","ë†ë„"]},
            {key:"boil_time", text:"ë©´ì„ ëª‡ ë¶„ ëª‡ ì´ˆ ì‚¶ì„ ë•Œ ìµœì  ì‹ê°ì¸ê°€ìš”?", p:0, tags:["ì‹œê°„","ì‹ê°"]},
            {key:"soup_profile", text:"êµ­ë¬¼ì˜ ê¸°ë³¸ ì„±í–¥ì€?", p:0, tags:["êµ­ë¬¼","í”„ë¡œíŒŒì¼"]},
            {key:"egg_style", text:"ê³„ë€ì€ ì–´ë–»ê²Œ ì“°ì‹œë‚˜ìš”?", p:1, tags:["í† í•‘","ë‹¨ë°±ì§ˆ"]},
        ];

        const POLICY_TAGS = [
            ["í•„ìˆ˜","ë¬¼ëŸ‰","ì‹œê°„","êµ­ë¬¼"],
            ["ì¤‘ìš”","í† í•‘"],
        ];

        const LABELS = {
            water_ml: "ë¬¼ëŸ‰(ml)",
            boil_time: "ì‚¶ëŠ” ì‹œê°„",
            soup_profile: "êµ­ë¬¼ ì„±í–¥",
            egg_style: "ê³„ë€ ìŠ¤íƒ€ì¼",
        };  

        const norm = s => (s||"").toLowerCase().replace(/\s+/g,"");

       // â–¼ ì¶”ê°€: í”„ë¡œí•„ ì´ë¦„ ì¶”ì¶œ (ë¬¸ì¥ ì†ì—ì„œ ê¸°ì¡´ í”„ë¡œí•„ëª… ì°¾ì•„ë‚´ê¸°)
        function extractProfileNameFrom(text){
            const t = text.replace(/\s+/g,"");
            const names = Object.keys(store.profiles||{});
            let hit = null;
            for(const name of names){
                if(!name) continue;
                if(t.includes(name.replace(/\s+/g,""))) { hit = name; break; }
            }
            return hit;
        }

        // â–¼ ì¶”ê°€: ì§ˆë¬¸ì—ì„œ ì–´ë–¤ í•„ë“œë¥¼ ë¬»ëŠ”ì§€ íŒë³„
        function detectField(text){
            const t = norm(text);
            const isQuestion = /[?ï¼Ÿ]$/.test(text) || /(ëª‡|ì–´ë–»ê²Œ|ì•Œë ¤ì¤˜|ë³´ì—¬ì¤˜)/.test(t);
            if(/ë¬¼|ë¬¼ëŸ‰/.test(t) && isQuestion) return "water_ml";
            if(/ì‚¶|ë“|ì‹œê°„/.test(t) && isQuestion) return "boil_time";
            if(/ë§›/.test(t) && isQuestion) return "soup_profile";
            if(/ê³„ë€|í† í•‘/.test(t) && isQuestion) return "egg_style";
            return null;
        }

        // â–¼ ì¶”ê°€: ë‚¨ì€ ì§ˆë¬¸ ë‚˜ì—´
        function listNeedsFor(name){
            const prof = store.profiles?.[name];
            if(!prof) return "í•´ë‹¹ í”„ë¡œí•„ì´ ì—†ì–´ìš”.";
            const needs = getAllQuestions().filter(q=>!prof.facts?.[q.key]).map(q=>LABELS[q.key]||q.key);
            return needs.length ? `ì•„ì§ ë¯¸ë‹µë³€: ${needs.join(", ")}` : "ëª¨ë“  í•µì‹¬ ì§ˆë¬¸ì´ ì±„ì›Œì¡Œì–´ìš”!";
        }

        // â–¼ ì¶”ê°€: ìš”ì•½ ë¬¸ìì—´ ìƒì„±
        function makeSummary(name){
            const prof = store.profiles?.[name];
            if(!prof) return "í•´ë‹¹ í”„ë¡œí•„ì´ ì—†ì–´ìš”.";
            const pairs = getAllQuestions().map(q=>{
                const v = prof.facts?.[q.key];
                return `Â· ${LABELS[q.key]||q.key}: ${v? v : "(ë¯¸ë‹µë³€)"}`;
            });
            return `[${name}] ìš”ì•½\n` + pairs.join("\n");
        }

        // â–¼ ì¶”ê°€: ë‘ í”„ë¡œí•„ ë¹„êµ
        function compareProfiles(a,b, field=null){
            const A = store.profiles?.[a], B = store.profiles?.[b];
            if(!A || !B) return "ë¹„êµí•  í”„ë¡œí•„ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            const keys = field? [field] : getAllQuestions().map(q=>q.key);
            const lines = keys.map(k=>{
                const lab = LABELS[k]||k;
                const va = A.facts?.[k] ?? "(ë¯¸ë‹µë³€)";
                const vb = B.facts?.[k] ?? "(ë¯¸ë‹µë³€)";
                return `Â· ${lab}: ${a}=${va} | ${b}=${vb}`;
            });
            return `í”„ë¡œí•„ ë¹„êµ: ${a} vs ${b}\n` + lines.join("\n");
        }

        function escapeRegExp(s){ 
            return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); 
        }

        function detectFieldSmart(text){
            const base = detectField(text);
            if (base) return base;
            const syns = store.synonyms || {};
            for (const [field, words] of Object.entries(syns)) {
                for (const w of words || []) {
                    const patt = new RegExp(escapeRegExp(w), 'i');  // ì‚¬ìš©ì ì…ë ¥ íŒ¨í„´ ì•ˆì „ ë§¤ì¹­
                    if (patt.test(text)) return field;
                }
            }
            return null;
        }

        function learnFieldUsage(field, rawQ){
            if(!field) return;
            state.lastField = field;
            store.stats = store.stats || {};
            store.stats[field] = Math.min((store.stats[field] || 0) + 1, 1e6); // ì˜¤ë²„í”Œë¡œ ë°©ì§€

            const raw = (rawQ||"").trim();
            if (raw.length >= 6 && raw.length <= 60) {
                store.synonyms[field] = Array.from(new Set([ ...(store.synonyms[field]||[]), raw ])).slice(-50); // ìµœê·¼ 50ê°œ
            }
        }

        function respond(field, text, {save=true} = {}){
            learnFieldUsage(field, state._lastUserText); // ë§ˆì§€ë§‰ ì‚¬ìš©ì ì…ë ¥ì„ í•™ìŠµì— ì‚¬ìš©
            if(save){ 
                saveCurrentToStore(); 
                fsSaveIfConnected(); 
            }
            return text;
        }

        function answerQuestion(text){
            const t = norm(text);
            const detectedField = detectFieldSmart(text);
            if (detectedField) state.lastField = detectedField;

            //ëª©ë¡ì²´í¬
            const listKW = ["ëª©ë¡", "ë¦¬ìŠ¤íŠ¸", "ë¬´ìŠ¨ë¼ë©´", "ì–´ë–¤ë¼ë©´"];
            if (listKW.some(k => t.includes(k))) {
                const names = Object.keys(store.profiles || {});
                const active = store.active || state.ramenName || "";
                fsSaveIfConnected?.();
                if (!names.length) return respond(null, "ì•„ì§ ì €ì¥ëœ í”„ë¡œí•„ì´ ì—†ì–´ìš”.");
                const list = `í”„ë¡œí•„ ëª©ë¡: ${names.join(", ")}`;
                return respond(null, active ? `${list}\ní˜„ì¬ í™œì„±: [${active}]` : list);
            }

            //í”„ë¡œí•„ ì „í™˜
            let m = t.match(/(?:(.+?)(?:ìœ¼)?ë¡œì „í™˜|(.+?)ë¡œë°”ê¿”ì¤˜)/);

            if(m){
                const candRaw = m[1] || m[2];
                const cand = extractProfileNameFrom(candRaw || '') || candRaw;
                if(cand && store.profiles[cand]){
                    saveCurrentToStore();
                    loadProfile(cand);
                    fsSaveIfConnected();
                    return `í”„ë¡œí•„ì„ [${cand}]ìœ¼ë¡œ ì „í™˜í–ˆì–´ìš”.`;
                }
                return "ê·¸ ì´ë¦„ì˜ í”„ë¡œí•„ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ê¸°ì¡´ í”„ë¡œí•„ ì´ë¦„ìœ¼ë¡œ ë‹¤ì‹œ ë§ì”€í•´ ì£¼ì„¸ìš”.";
            }

            //ìš”ì•½/ì •ë¦¬
            if(/ìš”ì•½|ì •ë¦¬|í”„ë¡œí•„ë³´ì—¬ì¤˜|ì„¸íŒ…ë³´ì—¬ì¤˜/.test(t)){
                const name = extractProfileNameFrom(text) || store.active || state.ramenName;
                if(!name) return respond(null, "ì–´ëŠ í”„ë¡œí•„ì„ ìš”ì•½í• ì§€ ì•Œë ¤ì£¼ì„¸ìš”.");
                return respond(null, makeSummary(name));
            }

            //ë‚¨ì€ ì§ˆë¬¸
            if (/ë¯¸ë‹µë³€|ë‚¨ì€ì§ˆë¬¸|ë‚¨ì€ ì§ˆë¬¸|ì¶©ì¡±ë„|ì™„ë£Œìœ¨|/.test(t)) {
                const name = extractProfileNameFrom(text) || store.active || state.ramenName;
                if (!name) return respond(null, "ì–´ëŠ í”„ë¡œí•„ ê¸°ì¤€ì¸ì§€ ì•Œë ¤ì£¼ì„¸ìš”.");

                const prof = store.profiles?.[name];
                if (!prof) return respond(null, "í•´ë‹¹ í”„ë¡œí•„ì´ ì—†ì–´ìš”.");

                const total = getAllQuestions().length;
                const answered = getAllQuestions().filter(q => prof.facts?.[q.key]).length;
                const pct = Math.round((answered / total) * 100);

                // ìƒíƒœ/UI ë™ê¸°í™”: ì§ˆì˜í•œ í”„ë¡œí•„ì„ stateì— ì ì¬í•´ íƒœê·¸/ê²Œì´ì§€ê°€ ë§ê²Œ ë³´ì´ë„ë¡
                if (store.active !== name) {
                    saveCurrentToStore();
                    loadProfile(name); // state.facts/historyë¥¼ í•´ë‹¹ í”„ë¡œí•„ë¡œ
                }
                renderNeeds();                // needTags ê°±ì‹ 
                el('coverage').style.width = pct + "%"; // ê²Œì´ì§€ ê°±ì‹ 

                // ì¶©ì¡±ë„ë§Œ ìš”ì²­í•œ ê²½ìš°
                if (/ì¶©ì¡±ë„|ì™„ë£Œìœ¨|coverage|progress/.test(t)) {
                    return respond(null, `[${name}] ì¶©ì¡±ë„: ${pct}% (${answered}/${total})`);
                }

                // ë‚¨ì€ ì§ˆë¬¸ ëª©ë¡/ê°œìˆ˜ ë°˜í™˜
                const needs = getAllQuestions()
                    .filter(q => !prof.facts?.[q.key])
                    .map(q => LABELS[q.key] || q.key);

                const msg = needs.length
                    ? `ì•„ì§ ë¯¸ë‹µë³€(${needs.length}/${total}): ${needs.join(", ")}`
                    : "ëª¨ë“  í•µì‹¬ ì§ˆë¬¸ì´ ì±„ì›Œì¡Œì–´ìš”!";

                state.doneNotified = needs.length === 0; // ì™„ë£Œ ì•ˆë‚´ ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
                return respond(null, msg);
            }

            // 5) ë‘ í”„ë¡œí•„ ë¹„êµ: "ì‹ ë¼ë©´ê³¼ ì—´ë¼ë©´ ë¹„êµ", "â€¦ ë¬¼ëŸ‰ ë¹„êµ"
            m = text.match(/(.+?)ì™€\s+(.+?)\s*(?:ë¹„êµ|ì°¨ì´|ì–´ë•Œ|ì°¨ì´ëŠ”?|ë¹„êµí•´ì¤˜)/);
            if(m){
                const aRaw = (m[1]||"").trim();
                const bRaw = (m[2]||"").trim();
                const a = extractProfileNameFrom(aRaw) || aRaw;
                const b = extractProfileNameFrom(bRaw) || bRaw;
                const field = detectFieldSmart(text);
                return respond(field, compareProfiles(a,b,field));
            }

            // 6) íŠ¹ì • ê°’ ì§ˆì˜
            const field = detectField(text);
            if(field){
                const name = extractProfileNameFrom(text) || store.active || state.ramenName;
                if(!name) return respond(null, "ì–´ëŠ í”„ë¡œí•„ì˜ ê°’ì„ ë³¼ì§€ ì•Œë ¤ì£¼ì„¸ìš”.");
                const prof = store.profiles?.[name];
                if(!prof) return respond(null, "í•´ë‹¹ í”„ë¡œí•„ì´ ì—†ì–´ìš”.");
                const val = prof.facts?.[field];
                if(val===undefined || val==="") return respond(field, `[${name}]ì˜ ${LABELS[field]||field}ëŠ” ì•„ì§ ë¯¸ë‹µë³€ì´ì—ìš”.`);
                return respond(field, val ? `[${name}]ì˜ ${LABELS[field]||field}: ${val}`: `[${name}]ì˜ ${LABELS[field]||field}ëŠ” ì•„ì§ ë¯¸ë‹µë³€ì´ì—ìš”.`);
            }

        // ë§¤ì¹­ ì‹¤íŒ¨ â†’ null (í˜¸ì¶œ ì¸¡ì—ì„œ ê°€ì„¤(hypothesize)ë¡œ í´ë°±)
            return null; 
        }
        // --- ìœ í‹¸ ---
        const el = id => document.getElementById(id);

        function addBubble(role, text, {record=true}={}){
            if(role === 'ai'){
                const lastAi = [...state.history].reverse().find(m => m.role === 'ai');
                if(lastAi && lastAi.text === text){
                    return; // í™”ë©´ ì¤‘ë³µ ì¶œë ¥ ë°©ì§€
                }
            }

            if(record) state.history.push({role,text});
            const b = document.createElement('div');
            b.className = `bubble ${role==='ai'?'ai':'me'}`;
            b.innerText = text;
            el('chat').appendChild(b);
            el('chat').scrollTop = el('chat').scrollHeight;
            renderSummary();
        }

        function addCustomQuestion({ key, label, p = 2, tags = ["ì‚¬ìš©ìì •ì˜"] }) {
            key = key.replace(/\s+/g, "_").toLowerCase();
            // ì¤‘ë³µ ë°©ì§€
            if (getAllQuestions().some(q => q.key === key)) return null;
            store.schema = store.schema || { customQuestions: [] };
            store.schema.customQuestions.push({ key, label, p, tags });
            LABELS[key] = label;
            return key; // â† í•­ìƒ key(ë¬¸ìì—´) ë˜ëŠ” null
        }

        function getAllQuestions(){
            return [...QUESTION_BANK, ...(store.schema.customQuestions || [])];
        }

        function allDone(){
            return getAllQuestions().every(q => state.facts[q.key] !== undefined && state.facts[q.key] !== "");
        }

        function coverage(){
            const total = getAllQuestions().length;
            const answered = getAllQuestions().filter(q=> state.facts[q.key] !== undefined && state.facts[q.key] !== "").length;
            return Math.round((answered/total)*100);
        }

        function nextQuestion(){
            const all = getAllQuestions();
            const unanswered = all.filter(q=> !state.facts[q.key]);
            if(!unanswered.length) return null;
            unanswered.sort((a,b)=> a.p===b.p ? all.indexOf(a)-all.indexOf(b) : a.p-b.p);
            return unanswered[0];
        }

        function renderNeeds(){
            const needs = getAllQuestions().filter(q=> !state.facts[q.key]);
            const tagBox = el('needTags');
            tagBox.innerHTML = '';
            needs.slice(0,10).forEach(q=>{
                const t = document.createElement('span');
                t.className='tag'; 
                t.textContent = `ìš”ì²­: ${(LABELS[q.key]||q.key)}`;
                tagBox.appendChild(t);
            });
            el('coverage').style.width = coverage()+"%";
        }

        function renderPolicy(){
        const box = el('policyTags'); box.innerHTML='';
        POLICY_TAGS.forEach(line=>{
            const [lvl,...rest]=line;
            const group = document.createElement('span');
            group.className='tag';
            group.textContent = lvl+": "+rest.join(', ');
            box.appendChild(group);
        })
        }

        function renderSummary(){
            const s = el('summary');
            if(!state.ramenName){ 
                s.textContent = 'ì„¸ì…˜ì„ ì‹œì‘í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.'; 
                return; 
            }
            const rows = getAllQuestions().map(q=>{
                const v = state.facts[q.key];
                const value = (v===undefined||v==="")? '<span class="muted">(ë¯¸ë‹µë³€)</span>' : escapeHtml(String(v));
                const label = escapeHtml(LABELS[q.key] || q.key);
                return `<tr><td>${label}</td><td>${value}</td></tr>`;
            }).join('');
            s.innerHTML = `
            <div class="pill">í™œì„± í”„ë¡œí•„ <b style="margin-left:6px">${escapeHtml(state.ramenName||'(ì—†ìŒ)')}</b></div>
            <div style="margin:.6rem 0">ì¶©ì¡±ë„: <b>${coverage()}%</b></div>
            <table style="width:100%;border-collapse:collapse;border:1px solid #2a3347">
                <tbody>${rows}</tbody>
            </table>
            `;
            }

        function saveCurrentToStore(){
                if(!store.active) return;
                store.profiles[store.active] = {
                    facts: {...state.facts},
                    history: [...state.history],
                    updatedAt: Date.now(),
                    createdAt: store.profiles[store.active]?.createdAt || Date.now()
                };
        }

        function loadProfile(name){
            store.active = name;
            const p = store.profiles[name];
            if(p){
                state.ramenName = name;
                state.facts = {...(p.facts||{})};
                state.history = [...(p.history||[])];
            }else{
                state.ramenName = name;
                state.facts = {};
                state.history = [];
                store.profiles[name] = { facts:{}, history:[], createdAt: Date.now(), updatedAt: Date.now() };
            }
            state.doneNotified = allDone(); // âœ… ì¶”ê°€
            el('chat').innerHTML='';
            (state.history||[]).forEach(m=>{
                const b=document.createElement('div'); b.className=`bubble ${m.role==='ai'?'ai':'me'}`; b.innerText=m.text;
                el('chat').appendChild(b);
            });
            el('chat').scrollTop=el('chat').scrollHeight;
            renderSummary();
        }

        function escapeHtml(str){
        return str.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]));
        }

        function startSession(){
            const name = el('ramenName').value.trim() || 'ë‚˜ì˜ ë¼ë©´';
            saveCurrentToStore();     // í˜„ì¬ ì‘ì—… ì¤‘ì¸ í”„ë¡œí•„ ë¨¼ì € ì €ì¥
            loadProfile(name);        // ìƒˆ/ê¸°ì¡´ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸°

            if(state.history.length===0){
                addBubble('ai', `ì•ˆë…•í•˜ì„¸ìš”! [${state.ramenName}] ì—°êµ¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì œê°€ ë¨¼ì € ëª‡ ê°€ì§€ ë¬¼ì„ê²Œìš”.`);
                askNext();
            }else{
                addBubble('ai', `í”„ë¡œí•„ [${state.ramenName}]ì„(ë¥¼) ë¶ˆëŸ¬ì™”ì–´ìš”. ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.`);
                askNext();  
            }
            fsSaveIfConnected();      // íŒŒì¼ë¡œ ì €ì¥
        }

        function askNext(){
            const q = nextQuestion();
            if(!q){
            // âœ… ì™„ë£Œ ë©˜íŠ¸ëŠ” í•œ ë²ˆë§Œ
                if(!state.doneNotified){
                    addBubble('ai','ëª¨ë“  í•µì‹¬ ì§ˆë¬¸ì´ ì±„ì›Œì¡Œì–´ìš”! ì›í•˜ì‹œë©´ ë” ê¹Šê²Œ íŒŒê³ ë“¤ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.');
                    state.doneNotified = true;
                }
                return;
            }
            // âœ… ë‚¨ì€ ì§ˆë¬¸ì´ ìƒê¸°ë©´ í”Œë˜ê·¸ í•´ì œ (ì˜ˆ: ì§ˆë¬¸ì€í–‰ í™•ì¥ ë“±)
            state.doneNotified = false;
            
            const tip = q.hint? `(íŒíŠ¸: ${q.hint})` : '';
            addBubble('ai', q.text + tip);
            renderNeeds();
        }

        function labelToKey(label){
            const normed = label.replace(/\s+|\(.*?\)/g,"").toLowerCase();
            let best = null, bestLen = 0;
            for (const [k,v] of Object.entries(LABELS)){
                const vv = String(v||"").replace(/\s+|\(.*?\)/g,"").toLowerCase();
                if (vv === normed) return k;                 // ì™„ì „ì¼ì¹˜ ìš°ì„ 
                if (vv.length >= 2 && normed.includes(vv) && vv.length > bestLen){
                best = k; bestLen = vv.length;             // ê°€ì¥ ê¸´ ë¶€ë¶„ì¼ì¹˜
                }
            }
            return best;
        }

        function handleUserMessage(){
            const text = el('msg').value.trim();
            el('msg').value='';
            addBubble('me', text);

            const tnorm = norm(text);
            const LIST_TOKENS = ["ëª©ë¡","ë¦¬ìŠ¤íŠ¸","ë¬´ìŠ¨ë¼ë©´","ì–´ë–¤ë¼ë©´"];

            // 0) ë¨¼ì € ì§ˆë¬¸/ëª…ë ¹ ì¸í…íŠ¸ì¸ì§€ íŒë³„ â†’ ë§ìœ¼ë©´ answerQuestionë¥¼ ìš°ì„  ì²˜ë¦¬
            const intentLike = 
                /[?ï¼Ÿ]$/.test(text) || 
                /(ë‚¨ì€ì§ˆë¬¸|ë¯¸ë‹µë³€|ì¶©ì¡±ë„|ì™„ë£Œìœ¨|ë­ê°€ì•„ì§|ìš”ì•½|í”„ë¡œí•„ëª©ë¡|í™œì„±í”„ë¡œí•„|ì „í™˜|ë°”ê¿”ì¤˜|ë¹„êµ|ì°¨ì´)/.test(tnorm) ||
                LIST_TOKENS.some(k => tnorm.includes(k));

            if (intentLike) {
                const maybe = answerQuestion(text);
                if (maybe) {
                    addBubble('ai', maybe);
                    saveCurrentToStore(); 
                    fsSaveIfConnected();
                    return; 
                }
            }
            
            if (state.pendingTeach) {
                const raw = text.trim();
                if (raw === 'ì·¨ì†Œ') {
                    state.pendingTeach = null;
                    addBubble('ai', 'í•™ìŠµì„ ì·¨ì†Œí–ˆì–´ìš”.');
                    return;
                }
                if (!state.pendingTeach.key) {
                    // 1ë‹¨ê³„: í•„ë“œëª… ë°›ê¸°
                    const label = raw.replace(/[:ï¼š]+$/,'').trim();
                    const key = label.replace(/\s+/g, "_").toLowerCase();
                    const createdKey = addCustomQuestion({ key, label, p: 2 });
                    if (!createdKey) {
                        addBubble('ai', 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì´ì—ìš”. ë‹¤ë¥¸ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                        return;
                    }
                    state.pendingTeach.key = createdKey;
                    addBubble('ai', `ì¢‹ì•„ìš”! ì•ìœ¼ë¡œ "${label}"ì„(ë¥¼) ì¶”ì í• ê²Œìš”. ì§€ê¸ˆ ê°’ì€ ì–´ë–»ê²Œ ê¸°ë¡í• ê¹Œìš”?`);
                    return;
                } else {
                    // 2ë‹¨ê³„: ê°’ ë°›ê¸° â†’ ì €ì¥
                    const key = state.pendingTeach.key;
                    state.facts[key] = raw;
                    addBubble('ai', `í•™ìŠµ ì™„ë£Œ! ${LABELS[key]}: ${raw}`);
                    state.pendingTeach = null;
                    saveCurrentToStore(); fsSaveIfConnected(); renderSummary(); askNext();
                    return;
                }
            }

            // 1) ë¹ ë¥¸ ì „í™˜ ëª…ë ¹ì€ ì¦‰ì‹œ ì²˜ë¦¬
            if(text.startsWith('/use ')){
                const target = text.slice(5).trim();
                if(target){
                saveCurrentToStore();
                loadProfile(target);
                addBubble('ai', `í”„ë¡œí•„ì„ [${target}]ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.`);
                fsSaveIfConnected();
                if(!allDone()) askNext();
                return;
                }
            }

            // 2) â˜… ê°’ ì…ë ¥ ìš°ì„  ì €ì¥ (ëŒ€ê¸° ì¤‘ ì§ˆë¬¸ì´ ìˆìœ¼ë©´ ìš°ì„ ì ìœ¼ë¡œ ê·¸ í‚¤ì— ë°”ì¸ë”©)
            const pending = getAllQuestions().find(q => state.facts[q.key] === undefined || state.facts[q.key] === "");
            let consumedAsValue = false;

            if(pending){
                let val = text;
                if(pending.key === 'boil_time'){
                    const ms = text.match(/(\d+)\s*ë¶„(?:\s*(\d+)\s*ì´ˆ)?|^(\d+)\s*:\s*(\d+)$/);
                    if (ms) {
                    const m = parseInt(ms[1] || ms[3] || "0");
                    const s = parseInt(ms[2] || ms[4] || "0");
                    val = `${m}ë¶„ ${s ? s + "ì´ˆ" : ""}`.trim();
                    }
                } else if(pending.key === "water_ml"){
                    const compact = text.replace(/\s+/g, "");
                    const m = compact.match(/^(\d{2,4})\s*ml?$/i);
                    if (m) val = `${m[1]}ml`;
                }
                state.facts[pending.key] = val;
                consumedAsValue = true;              // âœ… ì¶”ê°€
                saveCurrentToStore(); fsSaveIfConnected(); 
                renderSummary(); renderNeeds();       // âœ… ë°”ë¡œ ê°±ì‹ 
            }

            // 3) â€œ?â€ê°€ ìˆëŠ” ì…ë ¥ë§Œ ìì—°ì–´ Q&Aë¡œ ê°„ì£¼ (ê°’ ì…ë ¥ ì˜¤ì¸ ë°©ì§€)
            const looksQuestion = 
                /[?ï¼Ÿ]$/.test(text) || 
                /(ëª‡|ì–´ë–»ê²Œ|ì•Œë ¤ì¤˜|ë³´ì—¬ì¤˜|ë¹„êµ|ì°¨ì´|ìš”ì•½|ì „í™˜|ë°”ê¿”ì¤˜)/.test(tnorm) ||
                LIST_TOKENS.some(k => tnorm.includes(k));

            if(looksQuestion){
                const maybeAnswer = answerQuestion(text);
                if(maybeAnswer){
                    addBubble('ai', maybeAnswer);
                    saveCurrentToStore();
                    fsSaveIfConnected();
                    if(consumedAsValue) askNext();
                    return;
                }
            }

            // 4) ê°’ ì €ì¥ì´ ì—†ê³  Q&Aë„ ì•„ë‹ˆë©´ ê°€ì„¤ ì œì‹œ(ì„ íƒ)
            if (!consumedAsValue) {
                // â‘  í•™ìŠµ í›„ë³´ ì°¾ê¸°
                const t = norm(text);
                // ë§¤ìš° ë‹¨ìˆœ: ë¬¸ì¥ ëì— ? ìˆê±°ë‚˜ 'ë­ì•¼/ì•Œë ¤ì¤˜' í¬í•¨ â†’ í•™ìŠµ ìœ ë„
                const looksTeach = /[?ï¼Ÿ]$/.test(text) || /(ë­ì•¼|ì•Œë ¤ì¤˜|ë¬´ì—‡|ì–´ë–¤|ì„¤ëª…)/.test(t);
                if (looksTeach) {
                    // ì‚¬ìš©ìì—ê²Œ í•„ë“œëª… ë¶™ì´ê¸° ìš”ì²­
                    state.pendingTeach = { original: text }; // â˜… ìƒíƒœë¡œ ë³´ê´€
                    addBubble('ai', `ì´ ì§ˆë¬¸ì„ ì €ì¥í•´ ë°°ìš¸ê¹Œìš”? ìƒˆ í•„ë“œ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš” (ì˜ˆ: 'ë©´ êµµê¸°').\nì·¨ì†Œí•˜ë ¤ë©´ 'ì·¨ì†Œ'ë¼ê³  ì…ë ¥í•˜ì„¸ìš”.`);
                } else {
                    addBubble('ai', 'ì¢‹ì€ í¬ì¸íŠ¸ì˜ˆìš”. í˜„ì¬ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ê°€ì„¤ì„ ì„¸ì›Œë³¼ê²Œìš”â€¦');
                    addBubble('ai', hypothesize());
                }
            }

            saveCurrentToStore();
            fsSaveIfConnected();
            if(consumedAsValue) askNext();
        }

        function hypothesize(){
        const w = state.facts.water_ml||'ë¬¼ëŸ‰ ë¯¸ì •';
        const t = state.facts.boil_time||'ì‹œê°„ ë¯¸ì •';
        const n = state.facts.noodle_type||'ë©´ íƒ€ì… ë¯¸ì •';
        const sp = state.facts.soup_profile||'êµ­ë¬¼ ì„±í–¥ ë¯¸ì •';
        const th = state.facts.spice_threshold||'ì„ê³„ ë¯¸ì •';
        let tips = [];
        const body = `í˜„ì¬ ì„¤ì •ì€ ë¬¼ ${w}, ì‚¶ê¸° ${t}, ë©´ ${n}, êµ­ë¬¼ ${sp}, ë§µê¸° ì„ê³„ ${th} ì…ë‹ˆë‹¤.`
        return body + (tips.length? "ì¶”ì²œ ì‹¤í—˜: " + tips.join(' ') : "í•µì‹¬ ì„¸íŒ…ì´ ê±°ì˜ ì±„ì›Œì¡Œì–´ìš”!");
        }

        // ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° (ìˆ˜ë™)
        function exportJSON(){
            const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `ramen_session_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
        }

        function importJSON(file){
            const r = new FileReader();
            r.onload = e => {
                try {
                // â˜… íŒŒì‹± & 1ì°¨ ê²€ì¦
                const raw = JSON.parse(e.target.result);
                if (!raw || typeof raw !== 'object') throw new Error('í˜•ì‹ ì˜¤ë¥˜');

                // â˜… í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì—­ì§ë ¬í™” (ìœ íš¨ íƒ€ì…ë§Œ ë°˜ì˜)
                const ramenName =
                    typeof raw.ramenName === 'string' && raw.ramenName.trim()
                    ? raw.ramenName.trim()
                    : 'ë‚˜ì˜ ë¼ë©´';

                const facts =
                    raw.facts && typeof raw.facts === 'object' ? raw.facts : {};

                // â˜… history: ë°°ì—´ + role/text ìœ íš¨ì„± + ìµœì†Œ í•„í„°ë§
                const history = Array.isArray(raw.history)
                    ? raw.history
                        .filter(m =>
                        m &&
                        (m.role === 'ai' || m.role === 'me') &&
                        typeof m.text === 'string'
                        )
                        .map(m => ({
                        role: m.role,
                        // textContentë¡œ ê·¸ë¦´ ê±°ë¼ XSS ê±±ì •ì€ ì ì§€ë§Œ, ê·¸ë˜ë„ trim
                        text: m.text.trim()
                        }))
                        // (ì„ íƒ) ì§€ë‚˜ì¹˜ê²Œ ê¸´ ë¡œê·¸ ë°©ì§€ìš© ìŠ¬ë¼ì´ì‹±
                        .slice(-500)
                    : [];

                // â˜… stateì— ê²€ì¦ëœ ê°’ë§Œ ë°˜ì˜
                state.ramenName = ramenName;
                state.facts = facts;
                state.history = history;

                // â˜… ì±„íŒ…ì°½ ì´ˆê¸°í™” & ì•ˆì „í•˜ê²Œ ë‹¤ì‹œ ë Œë” (textContent ì‚¬ìš©)
                const chat = el('chat');
                chat.innerHTML = '';
                for (const m of state.history) {
                    const b = document.createElement('div');
                    b.className = `bubble ${m.role === 'ai' ? 'ai' : 'me'}`;
                    b.textContent = m.text; // â˜… innerHTML ëŒ€ì‹  textContent
                    chat.appendChild(b);
                }
                chat.scrollTop = chat.scrollHeight;

                // ìš”ì•½/ìƒíƒœ ê°±ì‹ 
                if (typeof renderSummary === 'function') renderSummary();

                store.active = state.ramenName || 'ë‚˜ì˜ ë¼ë©´';
                saveCurrentToStore();
                fsSaveIfConnected();

                // ì•ˆë‚´ ë©˜íŠ¸
                addBubble('ai', 'ê°€ì ¸ì˜¨ ì„¸ì…˜ì„ ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.', { record: true });
                fsSaveIfConnected();
                } catch (err) {
                alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            };
            r.readAsText(file);
        }

        // --- File System Access API: ì„¸ì…˜ íŒŒì¼ ì—°ê²°/ì €ì¥/ë³µêµ¬ ---
        async function pickSessionFile(){
        if(!('showSaveFilePicker' in window)){
            alert('ì´ ë¸Œë¼ìš°ì €ëŠ” íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome/Edge ê¶Œì¥');
            return;
        }
        try{
            sessionHandle = await window.showSaveFilePicker({
            suggestedName: 'ramen_session.json',
            types: [{ description: 'JSON', accept: {'application/json': ['.json']} }]
            });
            await persistHandle(sessionHandle);
            await fsSaveIfConnected();
            addBubble('ai','ì„¸ì…˜ íŒŒì¼ê³¼ ì—°ê²°í–ˆì–´ìš”. ì´ì œë¶€í„° ìë™ ì €ì¥/ë¡œë”©ë©ë‹ˆë‹¤.');
        }catch(e){ /* ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš° ë“± ë¬´ì‹œ */ }
        }

        function ensureStoreScaffolding() {
            store.version = store.version || 2;
            store.profiles = store.profiles || {};
            store.active = store.active || null;
            store.schema = store.schema || { customQuestions: [] };
            store.synonyms = store.synonyms || {};
            store.stats = store.stats || {};
        }

        async function fsSaveIfConnected(){
            ensureStoreScaffolding();
        try{
            if(!sessionHandle) sessionHandle = await restoreHandle();
            if(!sessionHandle) return;

            saveCurrentToStore(); // stateâ†’store ë°˜ì˜
            const writable = await sessionHandle.createWritable();
            await writable.write(JSON.stringify(store, null, 2));
            await writable.close();
        }catch(e){ /* ê¶Œí•œ ê±°ë¶€/ì†ì‹¤ ì‹œ ë¬´ì‹œ */ }
        }

        async function fsLoadIfConnected(){
            ensureStoreScaffolding();
            try{
                if(!sessionHandle) sessionHandle = await restoreHandle();
                if(!sessionHandle) return false;
                const file = await sessionHandle.getFile();
                const data = JSON.parse(await file.text());
                
                if(data && data.profiles){ // v2
                    store.version = data.version || 2;
                    store.profiles = data.profiles || {};
                    store.active = data.active || Object.keys(store.profiles)[0] || null;
                    if(store.active){
                        loadProfile(store.active);
                        askNext();  
                    }else{
                        renderPolicy(); renderSummary();
                    }
                    return true;
                } else if(data && (data.ramenName || data.facts || data.history)){ // v1 â†’ v2
                    const name = data.ramenName || 'ë‚˜ì˜ ë¼ë©´';
                    store.version = 2;
                    store.profiles = {};
                    store.active = name;
                    store.profiles[name] = {
                        facts: data.facts || {},
                        history: data.history || [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };
                    loadProfile(name);
                    addBubble('ai','êµ¬ë²„ì „ ì„¸ì…˜ì„ ìƒˆ í¬ë§·ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í–ˆì–´ìš”.', {record:true});
                    await fsSaveIfConnected();          // â˜… ì €ì¥ ì‹œë„
                    console.log('migrated->saved');     // â˜… ì €ì¥ í™•ì¸ìš©
                    return true;
                }
            }catch(e){ /* í•¸ë“¤ ë§Œë£Œ/íŒŒì¼ ì‚­ì œ ë“± */ }
                return false;
        }

        // --- IndexedDBë¡œ íŒŒì¼ í•¸ë“¤ ë³´ì¡´ ---
        function idb(){
        return new Promise(res=>{
            const req = indexedDB.open('ramen-db',1);
            req.onupgradeneeded = ()=> req.result.createObjectStore('handles');
            req.onsuccess = ()=> res(req.result);
        });
        }
        async function persistHandle(handle){
        const db = await idb(); const tx = db.transaction('handles','readwrite');
        tx.objectStore('handles').put(handle,'session');
        return new Promise(ok=>{ tx.oncomplete = ()=> ok(); });
        }
        async function restoreHandle(){
        const db = await idb(); const tx = db.transaction('handles','readonly');
        return new Promise(ok=>{
            const r = tx.objectStore('handles').get('session');
            r.onsuccess = ()=> ok(r.result||null);
            r.onerror = ()=> ok(null);
        });
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        el('start').onclick = startSession;
        el('clear').onclick = ()=>{ 
            state.ramenName=''; state.facts={}; state.history=[]; 
            state.doneNotified = false; // âœ… ì¶”ê°€
            el('chat').innerHTML=''; renderSummary(); 
            try{ localStorage.removeItem('ramen_session_v1'); }catch(_){ }
            fsSaveIfConnected();
        };
        el('send').onclick = handleUserMessage;
        el('msg').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleUserMessage(); }});
        el('export').onclick = exportJSON;
        el('import').onclick = ()=> el('file').click();
        el('file').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
        el('connectFile').onclick = pickSessionFile;

        let _dirty = false;

        // ìƒíƒœê°€ ë³€í•  ë•Œ dirty í‘œì‹œ
        const markDirty = () => { _dirty = true; };

        // chatì°½ì˜ DOM ë³€ê²½ì„ ê°ì‹œ â†’ ì±„íŒ… ì¶”ê°€ ì‹œ dirty í”Œë˜ê·¸ í™œì„±í™”
        new MutationObserver(markDirty).observe(el('chat'), {
            childList: true,
            subtree: true
        });

        try{
            setInterval(() => {
                if (_dirty) {
                    try {
                    localStorage.setItem('ramen_session_v1', JSON.stringify(state));
                    } catch (err) {
                    console.warn('ìë™ ì €ì¥ ì‹¤íŒ¨:', err);
                    }
                    _dirty = false;
                }
            }, 2000);
        }catch(_){ }

        // í˜ì´ì§€ ë¡œë“œì‹œ: 1) íŒŒì¼ ìë™ ë³µêµ¬ ì‹œë„ -> 2) ì—†ìœ¼ë©´ localStorage ë³µêµ¬
        window.addEventListener('load', async ()=>{
        const loaded = await fsLoadIfConnected();
        if(!loaded){
            try{
            const saved = localStorage.getItem('ramen_session_v1');
            if(saved){
                const data = JSON.parse(saved);
                if(data && typeof data==='object'){
                    Object.assign(state, data);
                    el('chat').innerHTML='';
                    (state.history||[]).forEach(m=>{
                        const b = document.createElement('div');
                        b.className = `bubble ${m.role==='ai'?'ai':'me'}`;
                        b.innerText = m.text;
                        el('chat').appendChild(b);
                    });
                    el('chat').scrollTop = el('chat').scrollHeight;
                    renderSummary();
                    addBubble('ai','ì´ì „ ë¡œì»¬ ì„¸ì…˜ì„ ë³µêµ¬í–ˆì–´ìš” ğŸœ', {record:true});
                    askNext();  
                } else { renderPolicy(); renderSummary(); }
            } else { renderPolicy(); renderSummary(); }
            }catch(_){ renderPolicy(); renderSummary(); }
        }
        });
    </script>
</body>
</html>
