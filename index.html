<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ë¼ë©´ ì†Œìƒì Â· ì§ˆë¬¸í•˜ëŠ” AI (MVP)</title>
    <style>
        :root{
            --bg: #0b0d12; 
            --panel: #121621; 
            --panel-2: #1a2030; 
            --text: #e9edf5; 
            --muted: #a9b4c7;
            --acc: #7cc7ff; 
            --acc-2: #ffd37c; 
            --danger: #ff8a7c; 
            --ok: #8dff7c;
            --radius: 18px; 
            --shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        *{
            box-sizing: border-box
        }
        
        html,body{
            height: 100%
        }

        body{
            margin: 0;
            background: radial-gradient(1200px 800px at 80% -10%,#17203a33,transparent),var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Pretendard,sans-serif;
            color: var(--text);
        }

        .wrap{
            max-width: 980px;
            margin: 40px auto;
            padding: 0 16px
        }

        header{
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px
        }

        header .logo{
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg,var(--acc),var(--acc-2));
            display: grid;
            place-items: center;
            color: #0b0d12;
            font-weight: 900;
            box-shadow: var(--shadow)
        }

        header h1{
            font-size: clamp(20px,3.8vw,32px);
            margin: 0
        }

        header p{
            margin: 0;
            color: var(--muted)
        }

        .panel{
            background: linear-gradient(180deg,var(--panel),var(--panel-2));
            border: 1px solid #222a3a;
            border-radius: var(--radius);
            box-shadow: var(--shadow)
        }

        .grid{
            display: grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 16px
        }

        @media (max-width: 860px){
            .grid{
                grid-template-columns: 1fr;
            }
        }

        .section{
            padding: 18px
        }

        .section h2{
            margin: 0 0 10px;
            font-size: 18px
        }

        .section p.note{
            margin: .4rem 0 1rem;
            color: var(--muted);
            font-size: 14px
        }

        .row{
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 8px 0
        }

        .row input, .row select{
            flex: 1;
            background: #0f1421;
            border: 1px solid #2a3347;
            color: var(--text);
            border-radius: 12px;
            padding: 10px 12px
        }

        .row button{
            background: #1e2a42;
            border: 1px solid #2d3a58;
            color: var(--text);
            border-radius: 12px;
            padding: 10px 14px;
            cursor: pointer
        }

        .row button:hover{
            filter: brightness(1.1)
        }

        .chat{
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px;
            height: 460px;
            overflow: auto;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius)
        }

        .bubble{
            max-width: 82%;
            padding: 12px 14px;
            border-radius: 14px;
            line-height: 1.4
        }

        .ai{
            align-self: flex-start;
            background: #12213a;
            border: 1px solid #2b3c5a
        }

        .me{
            align-self: flex-end;
            background: #1d2a2f;
            border: 1px solid #2a3e3a
        }

        .inputbar{
            display: flex;
            gap: 10px;
            padding: 12px;
            border-top: 1px solid #26304a;
            background: #0e1422;
            border-bottom-left-radius: var(--radius);
            border-bottom-right-radius: var(--radius)
        }

        .inputbar textarea{
            flex: 1;
            background: #0f1421;
            border: 1px solid #2a3347;
            color: var(--text);
            border-radius: 12px;
            padding: 12px;
            height: 56px;
            resize: none
        }

        .inputbar button{
            background: linear-gradient(135deg,var(--acc),#9fe6ff);
            color: #0b0d12;
            border: none;
            font-weight: 700;
            border-radius: 12px;
            padding: 0 18px;
            cursor: pointer
        }

        .state{
            padding: 12px;
            border-top: 1px dashed #2a3347;
            font-size: 14px;
            color: var(--muted)
        }

        .tags{
            display: flex; 
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px
        }

        .tag{
            font-size: 12px;
            padding: 6px 8px;
            border-radius: 999px;
            background: #111928;
            border: 1px solid #26304a;
            color: #c8d6f0
        }

        .statbar{height:8px;background:#0e1422;border:1px solid #2b3550;border-radius:999px;overflow:hidden}
        .statbar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,#4fd1ff,#b2f09b)}

        .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #2c3750;border-radius:12px;background:#0e1422}
        .pill input{width:140px}
        .ghost{opacity:.8}
        .muted{color:var(--muted)}

        .actions{display:flex;gap:8px;flex-wrap:wrap}
    </style>
</head>
<body>
    <div class="wrap">
        <header>
        <div class="logo">ğŸœ</div>
        <div>
            <h1>ë¼ë©´ ì†Œìƒì Â· ì§ˆë¬¸í•˜ëŠ” AI</h1>
            <p>â€œAIê°€ ìŠ¤ìŠ¤ë¡œ ëª¨ë¥´ëŠ” ê²ƒì„ ë¬»ê³  ë°°ì›Œ ë¼ë©´ì„ ì¬íƒ„ìƒì‹œí‚¤ëŠ”â€ ì§ˆë¬¸ ì¤‘ì‹¬ MVP</p>
        </div>
        </header>

        <div class="grid">
        <!-- ì¢Œ: ì±„íŒ…/ì§ˆë¬¸ -->
        <section class="panel">
            <div class="section">
            <h2>ëŒ€í™”</h2>
            <p class="note">AIê°€ í˜„ì¬ ì§€ì‹ì˜ ë¹ˆì¹¸ì„ ë°œê²¬í•˜ë©´ ë¨¼ì € ì§ˆë¬¸í•©ë‹ˆë‹¤. ë‹µë³€ì€ ìì—°ì–´ë¡œ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”.</p>
            </div>
            <div id="chat" class="chat"></div>
            <div class="inputbar">
            <textarea id="msg" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ê±°ë‚˜, ì§ˆë¬¸í•˜ê³  ì‹¶ì€ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”. (ì˜ˆ: 2ë¶„ 30ì´ˆ ì‚¶ìœ¼ë©´ ë©´ ì‹ê°ì´ ì–´ë–¤ê°€ìš”?)"></textarea>
            <button id="send">ë³´ë‚´ê¸°</button>
            </div>
            <div class="state">
            <div>ì§€ì‹ ì¶©ì¡±ë„</div>
            <div class="statbar" aria-label="coverage"><i id="coverage"></i></div>
            <div class="tags" id="needTags"></div>
            </div>
        </section>

        <!-- ìš°: ì„¸íŒ…/ì„¸ì…˜/ìš”ì•½ -->
        <section class="panel">
            <div class="section">
            <h2>ì„¸ì…˜</h2>
            <div class="row">
                <span class="pill">ë¼ë©´ ì´ë¦„ <input id="ramenName" placeholder="ì˜ˆ: ì‹ ë¼ë©´Â·ì»¤ìŠ¤í…€ ë ˆì‹œí”¼"/></span>
                <button id="start">ì„¸ì…˜ ì‹œì‘</button>
                <button id="clear" class="ghost">ì´ˆê¸°í™”</button>
            </div>
            <p class="note">ì„¸ì…˜ì„ ì‹œì‘í•˜ë©´ AIê°€ ìš°ì„ ìˆœìœ„ ë†’ì€ ì§ˆë¬¸ë¶€í„° ìˆœì„œëŒ€ë¡œ ë˜ì§‘ë‹ˆë‹¤.</p>
            <div class="actions">
                <button id="export">ë°ì´í„° ë‚´ë³´ë‚´ê¸°(JSON)</button>
                <button id="import">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°(JSON)</button>
                <input type="file" id="file" accept="application/json" hidden />
                <button id="connectFile">ì„¸ì…˜ íŒŒì¼ ì—°ê²°</button>
                <span class="note" style="font-size:12px">(Git ì €ì¥ì†Œ ì•ˆì˜ <code>ramen_session.json</code>ê³¼ ì—°ê²° ê¶Œì¥)</span>
            </div>
            </div>
            <div class="section">
            <h2>ì§€ì‹ ìš”ì•½</h2>
            <div id="summary" class="muted">ì„¸ì…˜ì„ ì‹œì‘í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
            <div class="section">
            <h2>ì§ˆë¬¸ ì •ì±…</h2>
            <p class="note">í•„ìˆ˜ â†’ ì¤‘ìš” â†’ ì„ íƒ í•­ëª© ìˆœìœ¼ë¡œ ì§ˆë¬¸í•©ë‹ˆë‹¤. ì´ë¯¸ ë‹µí•œ ë‚´ìš©ì€ ê±´ë„ˆëœë‹ˆë‹¤.</p>
            <ul class="muted" style="margin:0 0 .5rem 1rem;line-height:1.6">
                <li>í•„ìˆ˜: ë¬¼ëŸ‰/ì‹œê°„, ë©´/ìŠ¤í”„ ê¸°ë³¸, ë§µê¸° ì„ê³„, êµ­ë¬¼ ë†ë„</li>
                <li>ì¤‘ìš”: í† í•‘(ê³„ë€, íŒŒ, ì¹˜ì¦ˆ), ê¸°ë¦„/ë§ˆëŠ˜/ê³ ì¶” ê°€ê°, ë¼ë©´ í›„ ìˆ™ì„±</li>
                <li>ì„ íƒ: ë¸Œëœë“œ/ì›ê°€/ì„ í˜¸ ì§€ì—­ë§›, ì˜ì–‘(ë‚˜íŠ¸ë¥¨/ì¹¼ë¡œë¦¬)</li>
            </ul>
            <div class="tags" id="policyTags"></div>
            </div>
        </section>
        </div>
    </div>

    <script>
        // --- ê°„ë‹¨í•œ ìƒíƒœ ---
        const state = {
            ramenName: "",
            facts: {}, // key -> value
            history: [], // {role:"ai"|"user", text}
            doneNotified: false,   // âœ… ì¶”ê°€: ì™„ë£Œ ë©˜íŠ¸ ì¤‘ë³µ ë°©ì§€
        };

        // â–¼ ì—¬ëŸ¬ ë¼ë©´ì„ ë‹´ëŠ” v2 ì €ì¥ì†Œ
        const store = { version: 2, profiles: {}, active: null };

        // File System Access API í•¸ë“¤ (ì„ íƒ ì‚¬í•­)
        let sessionHandle = null; // ì‚¬ìš©ì ì—°ê²° ì‹œ ì‹¤íŒŒì¼ë¡œ ìë™ ì €ì¥/ë¡œë“œ

        // ì§ˆë¬¸ ì„¤ê³„: key, text, hint, priority (0 í•„ìˆ˜, 1 ì¤‘ìš”, 2 ì„ íƒ), tags
        const QUESTION_BANK = [
        {key:"water_ml", text:"ë¬¼ì€ ëª‡ mLê°€ ê°€ì¥ ë§›ìˆë‚˜ìš”? (ì˜ˆ: 430mL)", hint:"ê³„ëŸ‰ì»µÂ·ì „ìì €ìš¸", p:0, tags:["ë¬¼ëŸ‰","ë†ë„"]},
        {key:"boil_time", text:"ë©´ì„ ëª‡ ë¶„ ëª‡ ì´ˆ ì‚¶ì„ ë•Œ ìµœì  ì‹ê°ì¸ê°€ìš”? (ì˜ˆ: 2ë¶„30ì´ˆ)", hint:"ìŠ¤í†±ì›Œì¹˜", p:0, tags:["ì‹œê°„","ì‹ê°"]},
        {key:"soup_profile", text:"êµ­ë¬¼ì˜ ê¸°ë³¸ ì„±í–¥ì€? (ë§µê¸°/ì§ ë§›/ê°ì¹ ë§›/ê¸°ë¦„ê¸° ì¤‘ ì–´ëŠ ì¶•ì„ ì„ í˜¸?)", hint:"í‚¤ì›Œë“œ: ì§„í•œ/ë‹´ë°±/ì¹¼ì¹¼", p:0, tags:["êµ­ë¬¼","í”„ë¡œíŒŒì¼"]},
        {key:"egg_style", text:"ê³„ë€ì€ ì–´ë–»ê²Œ ì“°ì‹œë‚˜ìš”? (ì•ˆì”€/í’€ì–´ì„œ/ìˆ˜ë€/ë°˜ìˆ™í† í•‘)", hint:"ì„ íƒÂ·ë³µìˆ˜ ê°€ëŠ¥", p:1, tags:["í† í•‘","ë‹¨ë°±ì§ˆ"]},
        ];

        const POLICY_TAGS = [
        ["í•„ìˆ˜","ë¬¼ëŸ‰","ì‹œê°„","ë©´","êµ­ë¬¼","ë§µê¸°"],
        ["ì¤‘ìš”","í† í•‘","í–¥","ê°€ê°","íƒ€ì´ë°"],
        ["ì„ íƒ","ë¸Œëœë“œ","ì›ê°€","ì·¨í–¥","ì˜ì–‘"],
        ];

        // --- ìœ í‹¸ ---
        const el = id => document.getElementById(id);
        function addBubble(role, text, {record=true}={}){
        if(record) state.history.push({role,text});
        const b = document.createElement('div');
        b.className = `bubble ${role==='ai'?'ai':'me'}`;
        b.innerText = text;
        el('chat').appendChild(b);
        el('chat').scrollTop = el('chat').scrollHeight;
        renderSummary();
        }
        function coverage(){
        const total = QUESTION_BANK.length;
        const answered = QUESTION_BANK.filter(q=> state.facts[q.key] !== undefined && state.facts[q.key] !== "").length;
        return Math.round((answered/total)*100);
        }
        function nextQuestion(){
        const unanswered = QUESTION_BANK.filter(q=> !state.facts[q.key]);
        if(unanswered.length===0) return null;
        unanswered.sort((a,b)=> a.p===b.p ? QUESTION_BANK.indexOf(a)-QUESTION_BANK.indexOf(b) : a.p-b.p);
        return unanswered[0];
        }

        function renderNeeds(){
        const needs = QUESTION_BANK.filter(q=> !state.facts[q.key]);
        const tagBox = el('needTags');
        tagBox.innerHTML = '';
        needs.slice(0,10).forEach(q=>{
            const t = document.createElement('span');
            t.className='tag'; t.textContent = `ìš”ì²­: ${q.key}`;
            tagBox.appendChild(t);
        });
        el('coverage').style.width = coverage()+"%";
        }

        function renderPolicy(){
        const box = el('policyTags'); box.innerHTML='';
        POLICY_TAGS.forEach(line=>{
            const [lvl,...rest]=line;
            const group = document.createElement('span');
            group.className='tag';
            group.textContent = lvl+": "+rest.join(', ');
            box.appendChild(group);
        })
        }

        function renderSummary(){
        const s = el('summary');
        if(!state.ramenName){ s.textContent = 'ì„¸ì…˜ì„ ì‹œì‘í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.'; return; }
        const rows = QUESTION_BANK.map(q=>{
            const v = state.facts[q.key];
            const value = (v===undefined||v==="")? '<span class="muted">(ë¯¸ë‹µë³€)</span>' : escapeHtml(String(v));
            return `<tr><td>${q.key}</td><td>${value}</td></tr>`;
        }).join('');
        s.innerHTML = `
            <div class="pill">í™œì„± í”„ë¡œí•„ <b style="margin-left:6px">${escapeHtml(state.ramenName||'(ì—†ìŒ)')}</b></div>
            <div style="margin:.6rem 0">ì¶©ì¡±ë„: <b>${coverage()}%</b></div>
            <table style="width:100%;border-collapse:collapse;border:1px solid #2a3347">
            <thead><tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #2a3347">í‚¤</th><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #2a3347">ê°’</th></tr></thead>
            <tbody>${rows}</tbody>
            </table>`;
        renderNeeds();
        }
        function saveCurrentToStore(){
            if(!store.active) return;
            store.profiles[store.active] = {
                facts: {...state.facts},
                history: [...state.history],
                updatedAt: Date.now(),
                createdAt: store.profiles[store.active]?.createdAt || Date.now()
            };
        }
        function loadProfile(name){
            store.active = name;
            const p = store.profiles[name];
            if(p){
                state.ramenName = name;
                state.facts = {...(p.facts||{})};
                state.history = [...(p.history||[])];
            }else{
                state.ramenName = name;
                state.facts = {};
                state.history = [];
                store.profiles[name] = { facts:{}, history:[], createdAt: Date.now(), updatedAt: Date.now() };
            }
            state.doneNotified = false; // âœ… ì¶”ê°€
            el('chat').innerHTML='';
            (state.history||[]).forEach(m=>{
                const b=document.createElement('div'); b.className=`bubble ${m.role==='ai'?'ai':'me'}`; b.innerText=m.text;
                el('chat').appendChild(b);
            });
            el('chat').scrollTop=el('chat').scrollHeight;
            renderSummary();
        }

        function escapeHtml(str){
        return str.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]));
        }

        function startSession(){
            const name = el('ramenName').value.trim() || 'ë‚˜ì˜ ë¼ë©´';
            saveCurrentToStore();     // í˜„ì¬ ì‘ì—… ì¤‘ì¸ í”„ë¡œí•„ ë¨¼ì € ì €ì¥
            loadProfile(name);        // ìƒˆ/ê¸°ì¡´ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸°

            if(state.history.length===0){
                addBubble('ai', `ì•ˆë…•í•˜ì„¸ìš”! [${state.ramenName}] ì—°êµ¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ì œê°€ ë¨¼ì € ëª‡ ê°€ì§€ ë¬¼ì„ê²Œìš”.`);
                askNext();
            }else{
                addBubble('ai', `í”„ë¡œí•„ [${state.ramenName}]ì„(ë¥¼) ë¶ˆëŸ¬ì™”ì–´ìš”. ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.`);
                askNext();  
            }
            fsSaveIfConnected();      // íŒŒì¼ë¡œ ì €ì¥
        }

        function askNext(){
            const q = nextQuestion();
            if(!q){
            // âœ… ì™„ë£Œ ë©˜íŠ¸ëŠ” í•œ ë²ˆë§Œ
                if(!state.doneNotified){
                    addBubble('ai','ëª¨ë“  í•µì‹¬ ì§ˆë¬¸ì´ ì±„ì›Œì¡Œì–´ìš”! ì›í•˜ì‹œë©´ ë” ê¹Šê²Œ íŒŒê³ ë“¤ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.');
                    state.doneNotified = true;
                }
                fsSaveIfConnected();
                return;
            }
            // âœ… ë‚¨ì€ ì§ˆë¬¸ì´ ìƒê¸°ë©´ í”Œë˜ê·¸ í•´ì œ (ì˜ˆ: ì§ˆë¬¸ì€í–‰ í™•ì¥ ë“±)
            state.doneNotified = false;
            
            const tip = q.hint? `(íŒíŠ¸: ${q.hint})` : '';
            addBubble('ai', q.text + tip);
            renderNeeds();
        }

        function handleUserMessage(){
            const text = el('msg').value.trim(); 
            if(!text) return;

            el('msg').value='';
            addBubble('me', text);

            // ë¹ ë¥¸ ì „í™˜: "/use ë¼ë©´ì´ë¦„"
            if(text.startsWith('/use ')){
                const target = text.slice(5).trim();
                if(target){
                    saveCurrentToStore();
                    loadProfile(target);
                    addBubble('ai', `í”„ë¡œí•„ì„ [${target}]ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.`);
                    fsSaveIfConnected();
                    askNext();  
                    return; // í•¨ìˆ˜ ë‚´ë¶€ì´ë¯€ë¡œ ì•ˆì „
                }
            }

            const lastQ = [...QUESTION_BANK].find(q=> !state.facts[q.key]);
            let advanced = false;
            if(lastQ){ 
                state.facts[lastQ.key] = text; 
                advanced = true;
            }

            if(/[?ï¼Ÿ]$/.test(text)){
                addBubble('ai', 'ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. ìš°ì„  í˜„ì¬ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ê°€ì„¤ì„ ì„¸ì›Œë³¼ê²Œìš”â€¦');
                const hypo = hypothesize();
                addBubble('ai', hypo);
            }

            saveCurrentToStore();
            fsSaveIfConnected();
            
            if(advanced){
                askNext();
            }
        }

        function hypothesize(){
        const w = state.facts.water_ml||'ë¬¼ëŸ‰ ë¯¸ì •';
        const t = state.facts.boil_time||'ì‹œê°„ ë¯¸ì •';
        const n = state.facts.noodle_type||'ë©´ íƒ€ì… ë¯¸ì •';
        const sp = state.facts.soup_profile||'êµ­ë¬¼ ì„±í–¥ ë¯¸ì •';
        const th = state.facts.spice_threshold||'ì„ê³„ ë¯¸ì •';
        let tips = [];
        if(state.facts.resting===undefined) tips.push('ì™„ì„± í›„ 20~40ì´ˆ ìˆ™ì„± í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë©´ ë©´ìˆ˜ í¡ìˆ˜ë¡œ ë†ë„ê°€ ì•ˆì •ë  ìˆ˜ ìˆì–´ìš”.');
        if(state.facts.aroma_oil===undefined) tips.push('í–¥ë¯¸ìœ ëŠ” ë¶ˆ ëˆ ë’¤ ê·¸ë¦‡ì— ë‘ë¥´ëŠ” ë°©ì‹ê³¼ ëƒ„ë¹„ì— ë°”ë¡œ ë„£ëŠ” ë°©ì‹ì„ ê°ê° ì‹œí—˜í•´ë³´ì„¸ìš”.');
        if(state.facts.egg_style===undefined) tips.push('ê³„ë€ì€ ìˆ˜ë€/ìŠ¤í¬ë¨ë¸”/ë°˜ìˆ™ í† í•‘ 3-wayë¡œ ë¹„êµí•´ë³´ë©´ ì¬ë¯¸ìˆì–´ìš”.');
        const body = `í˜„ì¬ ì„¤ì •ì€ ë¬¼ ${w}, ì‚¶ê¸° ${t}, ë©´ ${n}, êµ­ë¬¼ ${sp}, ë§µê¸° ì„ê³„ ${th} ì…ë‹ˆë‹¤.`
        return body + (tips.length? "ì¶”ì²œ ì‹¤í—˜: " + tips.join(' ') : "í•µì‹¬ ì„¸íŒ…ì´ ê±°ì˜ ì±„ì›Œì¡Œì–´ìš”!");
        }

        // ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° (ìˆ˜ë™)
        function exportJSON(){
        const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `ramen_session_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
        }
        function importJSON(file){
        const r = new FileReader();
        r.onload = e=>{
            try{
            const data = JSON.parse(e.target.result);
            if(!data || typeof data !== 'object') throw new Error('í˜•ì‹ ì˜¤ë¥˜');
            Object.assign(state, {ramenName:data.ramenName||'ë‚˜ì˜ ë¼ë©´', facts:data.facts||{}, history:data.history||[]});
            el('chat').innerHTML='';
            state.history.forEach(m=>{
                const b = document.createElement('div');
                b.className = `bubble ${m.role==='ai'?'ai':'me'}`;
                b.innerText = m.text;
                el('chat').appendChild(b);
            });
            el('chat').scrollTop = el('chat').scrollHeight;
            renderSummary();
            addBubble('ai','ê°€ì ¸ì˜¨ ì„¸ì…˜ì„ ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.', {record:true});
            fsSaveIfConnected();
            }catch(err){ alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
        };
        r.readAsText(file);
        }

        // --- File System Access API: ì„¸ì…˜ íŒŒì¼ ì—°ê²°/ì €ì¥/ë³µêµ¬ ---
        async function pickSessionFile(){
        if(!('showSaveFilePicker' in window)){
            alert('ì´ ë¸Œë¼ìš°ì €ëŠ” íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome/Edge ê¶Œì¥');
            return;
        }
        try{
            sessionHandle = await window.showSaveFilePicker({
            suggestedName: 'ramen_session.json',
            types: [{ description: 'JSON', accept: {'application/json': ['.json']} }]
            });
            await persistHandle(sessionHandle);
            await fsSaveIfConnected();
            addBubble('ai','ì„¸ì…˜ íŒŒì¼ê³¼ ì—°ê²°í–ˆì–´ìš”. ì´ì œë¶€í„° ìë™ ì €ì¥/ë¡œë”©ë©ë‹ˆë‹¤.');
        }catch(e){ /* ì‚¬ìš©ìê°€ ì·¨ì†Œí•œ ê²½ìš° ë“± ë¬´ì‹œ */ }
        }

        async function fsSaveIfConnected(){
        try{
            if(!sessionHandle) sessionHandle = await restoreHandle();
            if(!sessionHandle) return;

            saveCurrentToStore(); // stateâ†’store ë°˜ì˜
            const writable = await sessionHandle.createWritable();
            await writable.write(JSON.stringify(store, null, 2));
            await writable.close();
        }catch(e){ /* ê¶Œí•œ ê±°ë¶€/ì†ì‹¤ ì‹œ ë¬´ì‹œ */ }
        }

        async function fsLoadIfConnected(){
            try{
                if(!sessionHandle) sessionHandle = await restoreHandle();
                if(!sessionHandle) return false;
                const file = await sessionHandle.getFile();
                const data = JSON.parse(await file.text());
                
                if(data && data.profiles){ // v2
                    store.version = data.version || 2;
                    store.profiles = data.profiles || {};
                    store.active = data.active || Object.keys(store.profiles)[0] || null;
                    if(store.active){
                        loadProfile(store.active);
                        addBubble('ai','ì„¸ì…˜ íŒŒì¼ì—ì„œ ìë™ ë³µêµ¬í–ˆì–´ìš”.', {record:true});
                        askNext();  
                    }else{
                        renderPolicy(); renderSummary();
                    }
                    return true;
                } else if(data && (data.ramenName || data.facts || data.history)){ // v1 â†’ v2
                    const name = data.ramenName || 'ë‚˜ì˜ ë¼ë©´';
                    store.version = 2;
                    store.profiles = {};
                    store.active = name;
                    store.profiles[name] = {
                        facts: data.facts || {},
                        history: data.history || [],
                        createdAt: Date.now(),
                        updatedAt: Date.now()
                    };
                    loadProfile(name);
                    addBubble('ai','êµ¬ë²„ì „ ì„¸ì…˜ì„ ìƒˆ í¬ë§·ìœ¼ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜í–ˆì–´ìš”.', {record:true});
                    await fsSaveIfConnected();          // â˜… ì €ì¥ ì‹œë„
                    console.log('migrated->saved');     // â˜… ì €ì¥ í™•ì¸ìš©
                    return true;
                }
            }catch(e){ /* í•¸ë“¤ ë§Œë£Œ/íŒŒì¼ ì‚­ì œ ë“± */ }
                return false;
        }

        // --- IndexedDBë¡œ íŒŒì¼ í•¸ë“¤ ë³´ì¡´ ---
        function idb(){
        return new Promise(res=>{
            const req = indexedDB.open('ramen-db',1);
            req.onupgradeneeded = ()=> req.result.createObjectStore('handles');
            req.onsuccess = ()=> res(req.result);
        });
        }
        async function persistHandle(handle){
        const db = await idb(); const tx = db.transaction('handles','readwrite');
        tx.objectStore('handles').put(handle,'session');
        return new Promise(ok=>{ tx.oncomplete = ()=> ok(); });
        }
        async function restoreHandle(){
        const db = await idb(); const tx = db.transaction('handles','readonly');
        return new Promise(ok=>{
            const r = tx.objectStore('handles').get('session');
            r.onsuccess = ()=> ok(r.result||null);
            r.onerror = ()=> ok(null);
        });
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        el('start').onclick = startSession;
        el('clear').onclick = ()=>{ 
            state.ramenName=''; state.facts={}; state.history=[]; 
            state.doneNotified = false; // âœ… ì¶”ê°€
            el('chat').innerHTML=''; renderSummary(); 
            try{ localStorage.removeItem('ramen_session_v1'); }catch(_){ }
            fsSaveIfConnected();
        };
        el('send').onclick = handleUserMessage;
        el('msg').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleUserMessage(); }});
        el('export').onclick = exportJSON;
        el('import').onclick = ()=> el('file').click();
        el('file').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
        el('connectFile').onclick = pickSessionFile;

        // ìë™ ì €ì¥(2ì´ˆë§ˆë‹¤) - localStorage (ë³´ì¡° ë°±ì—…)
        try{
        setInterval(()=>{
            localStorage.setItem('ramen_session_v1', JSON.stringify(state));
        }, 2000);
        }catch(_){ }

        // í˜ì´ì§€ ë¡œë“œì‹œ: 1) íŒŒì¼ ìë™ ë³µêµ¬ ì‹œë„ -> 2) ì—†ìœ¼ë©´ localStorage ë³µêµ¬
        window.addEventListener('load', async ()=>{
        const loaded = await fsLoadIfConnected();
        if(!loaded){
            try{
            const saved = localStorage.getItem('ramen_session_v1');
            if(saved){
                const data = JSON.parse(saved);
                if(data && typeof data==='object'){
                    Object.assign(state, data);
                    el('chat').innerHTML='';
                    (state.history||[]).forEach(m=>{
                        const b = document.createElement('div');
                        b.className = `bubble ${m.role==='ai'?'ai':'me'}`;
                        b.innerText = m.text;
                        el('chat').appendChild(b);
                    });
                    el('chat').scrollTop = el('chat').scrollHeight;
                    renderSummary();
                    addBubble('ai','ì´ì „ ë¡œì»¬ ì„¸ì…˜ì„ ë³µêµ¬í–ˆì–´ìš” ğŸœ', {record:true});
                    askNext();  
                } else { renderPolicy(); renderSummary(); }
            } else { renderPolicy(); renderSummary(); }
            }catch(_){ renderPolicy(); renderSummary(); }
        }
        });
    </script>
</body>
</html>
